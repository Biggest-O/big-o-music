<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// 1. DATABASE CONNECTION
const SUPABASE_URL = 'https://gbywinmjvbgrtaazjlgm.supabase.co';
const SUPABASE_KEY = 'sb_publishable_Bli__qzQMokBoSXPrFPHKA_DXVXgM2a';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const tracks = [
  { id: "when_i_think_about_you", t: "When I Think About You", f: "songs/when-i-think-about-you.mp3" },
  { id: "ariya", t: "Ariya", f: "songs/ariya.mp3" },
  { id: "nice_like_this", t: "Nice Like This", f: "songs/nice-like-this.mp3" },
  { id: "youre_my_home", t: "You're My Home", f: "songs/youre-my-home.mp3" },
  { id: "feeling_down", t: "Feeling Down", f: "songs/feeling-down.mp3" }
];

let audio = new Audio(), currentIdx = 0, context, analyser, source, hue = 180;
let isShuffle = false, isRepeat = false, drops = [];

// 2. FETCH REAL VOTES FROM SUPABASE
async function refreshList() {
  const { data: votesData, error } = await sb.from('Votes').select('*');
  if (error) console.error("Database Fetch Error:", error);

  const container = document.getElementById('song-container');
  // WE ADDED THIS: Makes sure the container exists before trying to draw the songs
  if (!container) return;

  container.innerHTML = tracks.map((s, index) => {
    const row = votesData?.find(r => r.song_id === s.id) || { likes: 0, dislikes: 0 };
    return `
      <div class="track-card">
        <div>
          <h3 style="margin:0; font-size: 1.2rem; letter-spacing: 1px;">${s.t}</h3>
          <div class="vote-container">
            <button class="vote-button" onclick="handleVote('${s.id}','likes')">üëç ${row.likes}</button>
            <button class="vote-button" onclick="handleVote('${s.id}','dislikes')">üëé ${row.dislikes}</button>
          </div>
        </div>
        <button class="action-btn" onclick="initAndPlay(${index})">Play</button>
      </div>
    `;
  }).join('');
}

// 3. SEND VOTE TO SUPABASE
async function handleVote(songId, type) {
  const { error } = await sb.rpc('increment_vote', { 
    song: songId, 
    col: type 
  });

  if (error) {
    console.error("Vote Error:", error.message);
  } else {
    refreshList(); 
  }
}

// Initial Build
refreshList();

// --- KEEP ALL YOUR NEON VISUALIZER LOGIC BELOW ---
// (initAndPlay, setupVisualizer, animate, toggle, next, prev, etc.)
