<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Experience</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; color: white; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 10; width: 320px; max-height: 90vh; 
              overflow-y: auto; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 15px; border: 1px solid #333; }
        .track-card { background: #111; margin-bottom: 12px; padding: 15px; border-radius: 10px; border: 1px solid #222; }
        .vote-btn { background: #222; color: white; border: 1px solid #444; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .play-btn { background: #1DB954; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; float: right; }
        h1 { font-size: 1.5rem; margin-top: 0; color: #1DB954; }
    </style>
</head>
<body>

    <div id="ui">
        <h1>My Tracks</h1>
        <div id="song-container">Syncing with database...</div>
    </div>

    <canvas id="canvas"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // 1. SUPABASE CONNECTION (Using your specific keys)
        const SUPABASE_URL = 'https://gbywinmjvbgrtaazjlgm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Bli__qzQMokBoSXPrFPHKA_DXVXgM2a';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const tracks = [
            { id: "when_i_think_about_you", t: "When I Think About You", f: "songs/when-i-think-about-you.mp3" },
            { id: "ariya", t: "Ariya", f: "songs/ariya.mp3" },
            { id: "nice_like_this", t: "Nice Like This", f: "songs/nice-like-this.mp3" },
            { id: "youre_my_home", t: "You're My Home", f: "songs/youre-my-home.mp3" },
            { id: "feeling_down", t: "Feeling Down", f: "songs/feeling-down.mp3" }
        ];

        // 2. AUDIO & VISUALIZER SETUP
        let audio = new Audio();
        let context, analyser, source;
        let canv = document.getElementById('canvas');
        let ctx = canv.getContext('2d');

        function initAndPlay(idx) {
            // Setup audio context on first click
            if(!context) {
                context = new (window.AudioContext || window.webkitAudioContext)();
                analyser = context.createAnalyser();
                source = context.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(context.destination);
                animate(); // Starts the visualizer loop
            }
            audio.src = tracks[idx].f;
            audio.play();
            context.resume();
        }

        // 3. DATABASE LOGIC (Points to your 'Votes' table)
        async function refreshList() {
            const container = document.getElementById('song-container');
            const { data: votes, error } = await sb.from('Votes').select('*');
            
            if (error) { console.error("Database Error:", error); return; }

            container.innerHTML = tracks.map((s, index) => {
                const v = votes?.find(row => row.song_id === s.id) || { likes: 0, dislikes: 0 };
                return `
                    <div class="track-card">
                        <button class="play-btn" onclick="initAndPlay(${index})">Play</button>
                        <h3 style="margin:0; font-size:1rem;">${s.t}</h3>
                        <div style="margin-top:10px;">
                            <button class="vote-btn" onclick="handleVote('${s.id}', 'likes')">üëç ${v.likes}</button>
                            <button class="vote-btn" onclick="handleVote('${s.id}', 'dislikes')">üëé ${v.dislikes}</button>
                        </div>
                    </div>`;
            }).join('');
        }

        async function handleVote(songId, column) {
            // Calls your 'increment_vote' function in Supabase
            const { error } = await sb.rpc('increment_vote', { song: songId, col: column });
            if (error) console.error("Vote Error:", error);
            refreshList();
        }

        // 4. THE VISUALIZER DRAWING LOOP (Restores your frequency bars)
        function animate() {
            requestAnimationFrame(animate);
            canv.width = window.innerWidth;
            canv.height = window.innerHeight;
            
            let data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canv.width, canv.height);
            
            let barWidth = (canv.width / data.length) * 2.5;
            let x = 0;
            for(let i = 0; i < data.length; i++) {
                let h = data[i] * 2;
                ctx.fillStyle = `hsl(${i + 180}, 100%, 50%)`;
                ctx.fillRect(x, canv.height - h, barWidth, h);
                x += barWidth + 1;
            }
        }

        document.addEventListener('DOMContentLoaded', refreshList);
    </script>
</body>
</html>
